# üéß Async Transcription Service

–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞–Ω–∏—è –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º FastAPI, Redis –∏ –≤–æ—Ä–∫–µ—Ä–æ–≤.

---

## üì¶ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–æ–¥–µ–ª–µ–π Whisper
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á (–≤–æ—Ä–∫–µ—Ä—ã)
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å —Å –ø–æ–º–æ—â—å—é Docker Compose
- –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è Redis
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω [Docker](https://www.docker.com/), [Docker Compose](https://docs.docker.com/compose/) –∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –º–æ–¥–µ–ª–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ ./_cache/whisper, –∏–Ω–∞—á–µ –∑–∞–≥—Ä—É–∑–∫–∞ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.

## üîß –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫

```bash
docker compose up --build --scale worker=4
```

- API –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:8000
- Redis —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
- –í–æ—Ä–∫–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–∏—Ç–∞—é—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∑–∞–¥–∞—á–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏

---

## üõ† –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä–æ–≤

–î–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —á–∏—Å–ª–∞ –≤–æ—Ä–∫–µ—Ä–æ–≤:

```bash
docker compose up --scale worker=10 -d
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```bash
.
‚îú‚îÄ‚îÄ _cache/
‚îÇ   ‚îî‚îÄ‚îÄ wisper                 # –ö—ç—à –º–æ–¥–µ–ª–∏ Whisper
‚îÇ       ‚îú‚îÄ‚îÄ base.pt
‚îÇ       ‚îú‚îÄ‚îÄ large.pt
‚îÇ       ‚îú‚îÄ‚îÄ small.pt
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ .devcontainer/
‚îÇ   ‚îú‚îÄ‚îÄ devcontainer.json      # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è VS Code –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile             # –î–æ–∫–µ—Ä—Ñ–∞–π–ª –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ core
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py          # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ decorators.py      # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.py           # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ services               # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ audio_service.py   # –û–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ Whisper
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ redis_service.py   # –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å redis
‚îú‚îÄ‚îÄ benchmark/
‚îÇ   ‚îú‚îÄ‚îÄ audios/                # –ê—É–¥–∏–æ –∑–∞–ø–∏—Å–∏ –¥–ª—è —Ç–µ—Å—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ plots/                 # –ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–∏–Ω—è –º–æ–¥–µ–ª–µ—Ñ
‚îÇ   ‚îú‚îÄ‚îÄ text-references/       # –≠—Ç–∞–ª–æ–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è —Å–≤–µ—Ä–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ run.py                 # –°–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π
‚îú‚îÄ‚îÄ logs/                      # –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ shared_audio/              # –û–±—â–∏–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ logger.py              # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ main.py                    # FastAPI —Å–µ—Ä–≤–µ—Ä
‚îú‚îÄ‚îÄ worker.py                  # –í–æ—Ä–∫–µ—Ä—ã, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏–µ –æ—á–µ—Ä–µ–¥—å
‚îú‚îÄ‚îÄ Dockerfile.api             # Dockerfile –¥–ª—è API
‚îú‚îÄ‚îÄ Dockerfile.worker          # Dockerfile –¥–ª—è –≤–æ—Ä–∫–µ—Ä–æ–≤
‚îú‚îÄ‚îÄ docker-compose.yml         # Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ requirements.txt           # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îî‚îÄ‚îÄ README.md                  # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

---

## üì§ API

### `POST /transcribe/`

–û—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞ –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é.

#### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:
| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø    | –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π | –û–ø–∏—Å–∞–Ω–∏–µ                                                                          |
| -------- | ------ | -------------|---------------------------------------------------------------------------------- |
| `file`   | —Ñ–∞–π–ª   | ‚úÖ           | –ê—É–¥–∏–æ—Ñ–∞–π–ª (`.mp3`, `.wav`, `.m4a` –∏ —Ç.–¥.)                                         |
| `model`  | —Å—Ç—Ä–æ–∫–∞ | ‚ùå           | –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ (`tiny`, `base`, `small`, `medium`, `large`, `turbo`)             |

–î–µ—Ñ–æ–ª—Ç–Ω–∞—è –º–æ–¥–µ–ª—å - `turbo`

#### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:
```
curl -F "file=@example.m4a" \
     "http://localhost:8000/transcribe/?model=base&trim=30"
```

#### –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:
```json
{
  "task_id": "abc123",
  "status": "queued"
}
```

### `GET /transcribe/{task_id}`

–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.

#### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—É—Ç–∏:
| –ü–∞—Ä–∞–º–µ—Ç—Ä  | –¢–∏–ø    | –û–ø–∏—Å–∞–Ω–∏–µ                    |
| --------- | ------ |---------------------------- |
| `task_id` | —Å—Ç—Ä–æ–∫–∞ | ID –∑–∞–¥–∞—á–∏, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ä–∞–Ω–µ–µ |

#### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:
```
curl http://localhost:8000/status/abc123
```

#### –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:

### –°—Ç–∞—Ç—É—Å: –≤ –æ—á–µ—Ä–µ–¥–∏

```json
{
  "task_id": "1234...",
  "status": "queued",
}
```

### –°—Ç–∞—Ç—É—Å: –æ–±—Ä–∞–±–æ—Ç–∫–∞

```json
{
  "task_id": "1234...",
  "status": "processing",
}
```

### –°—Ç–∞—Ç—É—Å: –≥–æ—Ç–æ–≤–æ

```json
{
  "task_id": "1234...",
  "status": "done",
  "result": {
    "text": "–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...",
    ...
  },
}
```

### –°—Ç–∞—Ç—É—Å: –æ—à–∏–±–∫–∞

```json
{
  "task_id": "1234...",
  "status": "error",
}
```

---

## üìä –ë–µ–Ω—á–º–∞—Ä–∫

–î–ª—è —Ç–µ—Å—Ç–∞ –Ω—É–∂–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã –∏ —Ç–µ–∫—Å—Ç-—Ä–µ—Ñ–µ—Ä–µ–Ω—Å –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏ —Ç–µ–∫—Å—Ç–∞-—Ä–µ—Ñ–µ—Ä–µ–Ω—Å–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ.

```
audio -> sample1.m4a
reference -> sample1.txt
```

–¢–∞–∫ –∂–µ –¥–æ–ø—É—Å–∫–∞—é—Ç—Å—è –≤–∞—Ä–∏–∞–Ω—Ç—ã

```
audio -> sample1-loud.m4a
reference -> sample1.txt
```

–î–∞–ª–µ–µ –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

```
docker compose run --rm benchmark
```

–ò –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç

```
python3 -m benchmark.run
```

---

## ‚öôÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ü—Ä–∏–º–µ—Ä `.env` —Ñ–∞–π–ª–∞:

```env
DEFAULT_MODEL=base
DEFAULT_DURATION=30
LOG_LEVEL=INFO
ALLOWED_EXTENSIONS=.mp3,.wav,.m4a,.aac,.ogg

REDIS_QUEUE_NAME = "transcribe_tasks"
REDIS_RESULTS_PREFIX = "transcribe_result:"
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_DB=0

UPLOAD_DIR=/app/shared_audio

WHISPER_BEAM_SIZE=5
```

---

## üë∑üèª‚Äç‚ôÇÔ∏è –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ docker

`.env` —Ñ–∞–π–ª –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º:

```
REDIS_HOST=localhost
UPLOAD_DIR=/shared_audio
```

- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ VS Code —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `Dev Containers`
- –í –æ–¥–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç–µ `uvicorn main:app --reload --host 0.0.0.0 --port 8000`
- –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç–µ `watchmedo auto-restart --patterns="*.py" --recursive -- python worker.py`

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

#### –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å python –æ–∫—Ä—É–∂–µ–Ω–∏–µ
_(–ù–∞ 11.06.2025 –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è python 3.11, –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É—Ç–∏–ª–∏—Ç—É ___pyenv___)_

```bash
python3.11 -m venv venv
```

#### –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ

macOS / Linux
```bash
source venv/bin/activate
```

Windows (CMD)
```bash
venv\Scripts\activate
```

Windows (PowerShell)
```bash
.\venv\Scripts\Activate.ps1
```

#### –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
pip install -r requirements.txt
```

#### –î–ª—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É

```bash
deactivate
```

---

## üìö –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–§–∞–π–ª `requirements.txt`:

```txt
python-multipart
fastapi
uvicorn
openai-whisper
faster-whisper
typer
dotenv
jiwer>=3.0.0
matplotlib
redis
torch
aiofiles
```

---

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- –í—Å–µ –ª–æ–≥–∏ –ø–∏—à—É—Ç—Å—è –≤ —Ñ–∞–π–ª logs/service.log
- –¢–∞–∫–∂–µ –ª–æ–≥–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ stdout
- –ì–æ—Ç–æ–≤–æ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é —Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ –ª–æ–≥-—Å–µ—Ä–≤–∏—Å–∞ (Logtail, ELK, Grafana Loki –∏ –¥—Ä.)

---

## üìö –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–¥–µ–ª–µ–π

–î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –º–æ–¥–µ–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ, –ø–æ–º–µ—Å—Ç–∏—Ç–µ –∑–∞—Ä–∞–Ω–µ–µ —Å–∫–∞—á–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `_cache/whisper`. –≠—Ç–æ —É—Å–∫–æ—Ä–∏—Ç –ø–µ—Ä–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤.

---

## üßº –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

```bash
docker compose down --rmi all --volumes
```

–£–¥–∞–ª–∏—Ç –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ volume (–≤–∫–ª—é—á–∞—è Redis-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ).

---

## üìÉ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License
